<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Royal Crush — Fixed-Damage Tracker (Fast)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --muted:#202534; --ink:#e9eef6; --sub:#aab3c2;
    --accent:#6ee7b7; --accent-2:#60a5fa; --warn:#f59e0b; --danger:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
    font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:840px;margin:0 auto;padding:16px}
  h1{margin:0 0 12px;font-size:20px}
  .card{
    background:linear-gradient(180deg,var(--panel),#121722);
    border:1px solid #272c3b; border-radius:14px; padding:14px; box-shadow:var(--shadow)
  }
  .grid{display:grid; gap:10px}
  .g3{grid-template-columns:repeat(3,1fr)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .pill{background:#141a24;border:1px solid #293143;border-radius:999px;padding:6px 10px;color:#cfe3ff;font-size:12px}
  .sub{color:var(--sub);font-size:12px}
  .bar{height:14px;background:#0e1420;border:1px solid #283045;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#34d399)}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3040;background:#0f131b;color:#e9eef6}
  .btn{padding:10px 12px;border-radius:12px;border:1px solid #2b3040;background:#151924;color:#e9eef6;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:transparent}
  .btn.red{background:#2a1215;border-color:#3a1a1e;color:#ffdada}
  .btn.yellow{background:#2e2613;border-color:#463a16;color:#fff1c2}
  .btn.blue{background:#14243b;border-color:#1e3554;color:#d9ecff}
  .hint{font-size:12px;color:#95a3ba}
  .section-title{font-size:13px;color:#b8c5da;margin:6px 0}
  .boss-btn{flex:1 1 140px;padding:10px;border-radius:12px;border:1px solid #2b3040;background:#171b25;color:#e9eef6;text-align:left}
  .boss-btn.active{outline:2px solid var(--accent-2);background:#132033}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono","Courier New",monospace}

  /* Performance mode (lighter styles) */
  .perf .card{background:#151923; box-shadow:none}
  .perf .bar>span{background:#60a5fa}
</style>
</head>
<body>
<div class="wrap">
  <h1>Royal Crush — Fixed-Damage Tracker</h1>

  <div class="row" style="margin-bottom:8px">
    <label class="row" style="gap:6px">
      <input type="checkbox" id="perfModeChk" />
      <span class="sub">Performance Mode (reduce effects & haptics)</span>
    </label>
    <button class="btn ghost" id="clearSaveBtn">Clear Save</button>
  </div>

  <div class="card">
    <!-- Boss header -->
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="sub">Current Royal</div>
        <div style="font-size:22px;font-weight:700" id="bossName">—</div>
        <div class="sub" id="bossStatsSub">HP — • DMG —</div>
      </div>
      <div style="text-align:right">
        <div class="sub">Boss HP</div>
        <div style="font-size:26px;font-weight:700"><span id="hpNow">0</span>/<span id="hpMax">0</span></div>
      </div>
    </div>
    <div class="bar" style="margin:10px 0 12px"><span id="hpBar" style="width:0%"></span></div>

    <!-- Player panel -->
    <div class="grid g3">
      <div class="card" style="padding:10px">
        <div class="section-title">Hero</div>
        <div class="row">
          <div class="pill">HP: <span id="heroHP">30</span></div>
          <button class="btn" id="hpMinus">-1</button>
          <button class="btn" id="hpPlus">+1</button>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="pill">Plays: <span id="playsLeft">3</span> / <span id="playsMax">3</span></div>
          <div class="pill">Shield: <span id="shieldVal">0</span></div>
        </div>
        <div class="hint" style="margin-top:6px">Start of round: Plays = 3. ♦ on hit can add up to +2 extra this round.</div>
      </div>

      <div class="card" style="padding:10px">
        <div class="section-title">Hit Check</div>
        <div class="row">
          <select id="cardVal">
            <option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5" selected>5</option><option value="6">6</option><option value="7">7</option>
            <option value="8">8</option><option value="9">9</option>
          </select>
          <select id="cardSuit">
            <option value="club">♣ Clubs</option>
            <option value="spade">♠ Spades</option>
            <option value="heart">♥ Hearts</option>
            <option value="diamond" selected>♦ Diamonds</option>
          </select>
          <button class="btn yellow" id="rollHitBtn">Roll d12</button>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="pill mono" id="lastRoll">—</div>
          <div class="pill mono" id="hitResult">—</div>
        </div>
        <div class="hint" style="margin-top:6px">
          Hit if d12 ≤ value. On natural 1: damage +1 (6 total). On 12: fumble (self-1).
        </div>
      </div>

      <div class="card" style="padding:10px">
        <div class="section-title">Boss Tools</div>
        <div class="row">
          <button class="btn yellow" id="abilityBtn">Boss Ability</button>
          <div class="pill mono" id="abilityOut">—</div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn red" id="bossTurnBtn">Boss Turn ➜ Next Round</button>
          <div class="pill mono" id="roundOut">Round 1</div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn blue" id="poiPlus">POI +1</button>
          <button class="btn" id="poiMinus">POI -1</button>
          <div class="pill">POI: <span id="poiVal">0</span></div>
        </div>
        <div class="hint" style="margin-top:6px">
          Boss Turn: POI ticks, ability bonus (if any) applied to DMG, Shield reduces DMG, then next Player round starts (Plays reset).
        </div>
      </div>
    </div>

    <!-- Quick damage/adjust -->
    <div class="row" style="margin-top:10px">
      <button class="btn red" data-delta="-5">Hit (−5)</button>
      <button class="btn red" data-delta="-6">Lucky 1 (−6)</button>
      <button class="btn" data-delta="+1">+1 HP</button>
      <button class="btn" data-delta="+3">+3 HP</button>
    </div>

    <!-- Boss picker -->
    <div class="section-title" style="margin-top:10px">Change Boss</div>
    <div class="row" id="bossButtons"></div>
    <div class="hint" style="margin-top:6px">Jacks 8/2 (≤3 +2) • Queens 12/4 (≤3 heal3) • Kings 16/5 (≤2 purge) • Joker 24/6 (8–10 ×2)</div>
  </div>

  <p class="hint" style="margin-top:12px">State auto-saves locally. Use Performance Mode if your device stutters.</p>
</div>

<script>
/* ----------------- Data ----------------- */
const bosses = [
  {id:'jack',  label:'J♣ J♠ J♥ J♦', name:'Jacks',  maxHP:8,  atk:2},
  {id:'queen', label:'Q♣ Q♠ Q♥ Q♦', name:'Queens', maxHP:12, atk:4},
  {id:'king',  label:'K♣ K♠ K♥ K♦', name:'Kings',  maxHP:16, atk:5},
  {id:'joker', label:'Joker Joker',  name:'Jokers', maxHP:24, atk:6},
];

const DMG_PER_HIT = 5; // nat-1 = +1
const HERO_MAX_HP = 30;
const BASE_PLAYS = 3;
const DIAMOND_EXTRA_CAP = 2;
const CLUB_SHIELD = 3;
const HEART_HEAL = 3;
const SPADE_POI = 1;

/* ----------------- State ----------------- */
let state = {
  bossId: 'jack',
  name: 'Jacks',
  hp: 8,
  maxHP: 8,
  atk: 2,

  heroHP: HERO_MAX_HP,
  plays: BASE_PLAYS,
  playsMax: BASE_PLAYS,
  diamondExtraEarned: 0, // how many extra plays granted this round (cap 2)
  shield: 0,
  poison: 0,

  round: 1,

  // ability flags for current boss swing
  jackPlus2: false,
  jokerTimes2: false,

  // UX
  perfMode: false,

  // undo
  history: []
};

/* ----------------- Elements ----------------- */
const $ = id => document.getElementById(id);
const els = {
  root: document.documentElement,
  bossName: $('bossName'),
  bossStatsSub: $('bossStatsSub'),
  hpNow: $('hpNow'),
  hpMax: $('hpMax'),
  hpBar: $('hpBar'),

  heroHP: $('heroHP'),
  hpMinus: $('hpMinus'),
  hpPlus: $('hpPlus'),

  playsLeft: $('playsLeft'),
  playsMax: $('playsMax'),
  shieldVal: $('shieldVal'),

  cardVal: $('cardVal'),
  cardSuit: $('cardSuit'),
  rollHitBtn: $('rollHitBtn'),
  lastRoll: $('lastRoll'),
  hitResult: $('hitResult'),

  abilityBtn: $('abilityBtn'),
  abilityOut: $('abilityOut'),

  bossTurnBtn: $('bossTurnBtn'),
  roundOut: $('roundOut'),

  poiPlus: $('poiPlus'),
  poiMinus: $('poiMinus'),
  poiVal: $('poiVal'),

  clearSaveBtn: $('clearSaveBtn'),
  perfModeChk: $('perfModeChk'),

  bossButtons: $('bossButtons')
};

/* ----------------- Perf-safe helpers ----------------- */
function vibrate(ms=15){
  if(state.perfMode) return;
  try { if (navigator && typeof navigator.vibrate === 'function') navigator.vibrate(ms); } catch {}
}

let saveTimer = null;
function scheduleSave(){
  if(saveTimer) return;
  saveTimer = setTimeout(()=>{
    saveTimer = null;
    const { history, ...lean } = state;
    try {
      localStorage.setItem('rc.fixed.fast', JSON.stringify(lean));
    } catch {}
  }, 300);
}
function load(){
  const raw = localStorage.getItem('rc.fixed.fast');
  if(!raw) return;
  try {
    const loaded = JSON.parse(raw);
    state = { ...state, ...loaded, history: [] };
    if(state.perfMode) els.root.classList.add('perf');
    els.perfModeChk.checked = !!state.perfMode;
  } catch {}
}

// render scheduler
let rafId = 0, dirty = false;
function scheduleRender(){
  if(dirty) return;
  dirty = true;
  rafId = requestAnimationFrame(_render);
}
function _render(){
  dirty = false;
  // boss
  els.bossName.textContent = state.name;
  els.bossStatsSub.textContent = `HP ${state.hp}/${state.maxHP} • DMG ${state.atk}`;
  els.hpNow.textContent = state.hp;
  els.hpMax.textContent = state.maxHP;
  els.hpBar.style.width = Math.max(0, Math.min(100, (state.hp/state.maxHP)*100)) + '%';
  // hero
  els.heroHP.textContent = state.heroHP;
  els.playsLeft.textContent = state.plays;
  els.playsMax.textContent = state.playsMax;
  els.shieldVal.textContent = state.shield;
  els.poiVal.textContent = state.poison;
  els.roundOut.textContent = `Round ${state.round}`;
  // perf class
  els.root.classList.toggle('perf', !!state.perfMode);
  // active boss highlight
  [...els.bossButtons.querySelectorAll('button')].forEach(b=>{
    b.classList.toggle('active', b.dataset.id===state.bossId);
  });
  scheduleSave();
}

/* ----------------- Undo (lean) ----------------- */
function pushHistory(){
  // Only capture essentials; cap to 5
  const snap = {
    bossId: state.bossId, name: state.name, hp: state.hp, maxHP: state.maxHP, atk: state.atk,
    heroHP: state.heroHP, plays: state.plays, playsMax: state.playsMax,
    diamondExtraEarned: state.diamondExtraEarned, shield: state.shield, poison: state.poison,
    round: state.round, jackPlus2: state.jackPlus2, jokerTimes2: state.jokerTimes2
  };
  state.history.push(snap);
  if(state.history.length>5) state.history.shift();
}
function undo(){
  const last = state.history.pop();
  if(!last) return;
  state = { ...state, ...last, history: state.history };
  scheduleRender();
}

/* ----------------- Boss switching/reset ----------------- */
function pickBoss(id){
  const b = bosses.find(x=>x.id===id);
  pushHistory();
  state.bossId = id;
  state.name = b.name;
  state.maxHP = b.maxHP;
  state.hp = b.maxHP;
  state.atk = b.atk;

  // reset round-level stats
  state.round = 1;
  state.poison = 0;
  state.shield = 0;
  state.plays = BASE_PLAYS;
  state.playsMax = BASE_PLAYS;
  state.diamondExtraEarned = 0;
  state.jackPlus2 = false;
  state.jokerTimes2 = false;

  scheduleRender();
}

function resetThisBoss(){
  pickBoss(state.bossId);
}

/* ----------------- Mutators (batched) ----------------- */
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

function applyBossHP(delta){
  pushHistory();
  state.hp = clamp(state.hp + delta, 0, state.maxHP);
  scheduleRender();
}

function applyHeroHP(delta){
  pushHistory();
  state.heroHP = clamp(state.heroHP + delta, 0, HERO_MAX_HP);
  scheduleRender();
}

function spendPlay(){
  if(state.plays <= 0) return false;
  pushHistory();
  state.plays -= 1;
  scheduleRender();
  return true;
}

function grantDiamondPlay(){
  if(state.diamondExtraEarned >= DIAMOND_EXTRA_CAP) return;
  pushHistory();
  state.diamondExtraEarned += 1;
  state.plays += 1;
  state.playsMax += 1;
  scheduleRender();
}

/* ----------------- Roll to Hit ----------------- */
function rollD12(){ return Math.floor(Math.random()*12)+1; }

function doHitRoll(){
  if(state.plays <= 0){ els.hitResult.textContent = 'No plays left'; return; }

  const val = Number(els.cardVal.value);  // 2..9
  const suit = els.cardSuit.value;        // club/spade/heart/diamond
  const r = rollD12();
  els.lastRoll.textContent = `d12: ${r}`;
  let result = '';

  // Fumble on 12
  if(r === 12){
    spendPlay();
    applyHeroHP(-1); // self damage
    result = 'FUMBLE: self-1';
    els.hitResult.textContent = result;
    vibrate(10);
    return;
  }

  // Miss if r > value
  if(r > val){
    spendPlay();
    result = 'Miss';
    els.hitResult.textContent = result;
    vibrate(5);
    return;
  }

  // Hit!
  if(!spendPlay()) return;

  let dmg = DMG_PER_HIT;
  if(r === 1) dmg += 1; // Lucky strike
  applyBossHP(-dmg);

  // Suit effects on hit
  if(suit === 'club'){
    pushHistory(); state.shield += CLUB_SHIELD; scheduleRender();
    result = `Hit −${dmg} • ♣ Shield +${CLUB_SHIELD}`;
  } else if(suit === 'spade'){
    pushHistory(); state.poison += SPADE_POI; scheduleRender();
    result = `Hit −${dmg} • ♠ POI +${SPADE_POI}`;
  } else if(suit === 'heart'){
    applyHeroHP(+HEART_HEAL);
    result = `Hit −${dmg} • ♥ Heal +${HEART_HEAL}`;
  } else if(suit === 'diamond'){
    grantDiamondPlay();
    result = `Hit −${dmg} • ♦ Draw 1 → +1 play (cap ${DIAMOND_EXTRA_CAP})`;
  }

  els.hitResult.textContent = result;
  vibrate(8);
}

/* ----------------- Boss ability + turn ----------------- */
function bossAbility(){
  const r = rollD12();
  let msg = `d12: ${r} • DMG ${state.atk}`;
  if(state.bossId === 'jack'){
    state.jackPlus2 = (r <= 3);
    msg = state.jackPlus2 ? `d12: ${r} • DMG ${state.atk+2} (base ${state.atk} +2)` : `d12: ${r} • DMG ${state.atk}`;
  } else if(state.bossId === 'queen'){
    if(r <= 3){
      pushHistory();
      state.hp = Math.min(state.maxHP, state.hp + 3);
      scheduleRender();
      msg = `d12: ${r} • Heal +3 • DMG ${state.atk}`;
    } else {
      msg = `d12: ${r} • DMG ${state.atk}`;
    }
  } else if(state.bossId === 'king'){
    if(r <= 2){
      pushHistory();
      const had = state.poison;
      state.poison = 0;
      scheduleRender();
      msg = `d12: ${r} • Purge ${had>0?'POI':'(none)'} • DMG ${state.atk}`;
    } else {
      msg = `d12: ${r} • DMG ${state.atk}`;
    }
  } else if(state.bossId === 'joker'){
    state.jokerTimes2 = (r >= 8 && r <= 10);
    msg = state.jokerTimes2 ? `d12: ${r} • DMG ${state.atk*2} (×2)` : `d12: ${r} • DMG ${state.atk}`;
  }
  els.abilityOut.textContent = msg;
}

function bossTurn(){
  pushHistory();

  // 1) POI tick at start of boss turn
  if(state.poison > 0){
    state.hp = Math.max(0, state.hp - state.poison);
  }

  // 2) Compute outgoing DMG
  let dmg = state.atk;
  if(state.bossId === 'jack' && state.jackPlus2) dmg += 2;
  if(state.bossId === 'joker' && state.jokerTimes2) dmg *= 2;

  // 3) Apply Shield
  const reduced = Math.max(0, dmg - state.shield);
  state.shield = 0;

  // 4) Hit hero
  state.heroHP = Math.max(0, Math.min(HERO_MAX_HP, state.heroHP - reduced));

  // 5) Clear ability flags for next round
  state.jackPlus2 = false;
  state.jokerTimes2 = false;
  els.abilityOut.textContent = `Boss dealt ${reduced}`;

  // 6) Next player round: reset plays and diamond cap
  state.round += 1;
  state.plays = BASE_PLAYS;
  state.playsMax = BASE_PLAYS;
  state.diamondExtraEarned = 0;

  scheduleRender();
}

/* ----------------- Quick buttons & picker ----------------- */
function initQuickDamageButtons(){
  document.querySelectorAll('[data-delta]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = Number(btn.getAttribute('data-delta'));
      if(d < 0){
        if(d === -5 || d === -6){
          if(state.plays <= 0){ els.hitResult.textContent = 'No plays left'; return; }
          spendPlay();
        }
        applyBossHP(d);
      }else{
        applyBossHP(d);
      }
    }, {passive:true});
  });
}

function initBossPicker(){
  const frag = document.createDocumentFragment();
  bosses.forEach(b=>{
    const el = document.createElement('button');
    el.className = 'boss-btn';
    el.dataset.id = b.id;
    el.innerHTML = `<strong>${b.label}</strong><div class="sub">HP ${b.maxHP} • DMG ${b.atk}</div>`;
    el.addEventListener('click', ()=> pickBoss(b.id), {passive:true});
    frag.appendChild(el);
  });
  els.bossButtons.appendChild(frag);
}

/* ----------------- Events ----------------- */
function init(){
  load();
  if(!state || !state.maxHP){ pickBoss('jack'); } else { scheduleRender(); }

  els.hpMinus.addEventListener('click', ()=> applyHeroHP(-1), {passive:true});
  els.hpPlus.addEventListener('click',  ()=> applyHeroHP(+1), {passive:true});

  els.rollHitBtn.addEventListener('click', doHitRoll);
  els.abilityBtn.addEventListener('click', bossAbility);
  els.bossTurnBtn.addEventListener('click', bossTurn);

  els.poiPlus.addEventListener('click', ()=>{ pushHistory(); state.poison += 1; scheduleRender(); }, {passive:true});
  els.poiMinus.addEventListener('click', ()=>{ pushHistory(); state.poison = Math.max(0, state.poison-1); scheduleRender(); }, {passive:true});

  els.clearSaveBtn.addEventListener('click', ()=>{
    try { localStorage.removeItem('rc.fixed.fast'); } catch {}
    pickBoss(state.bossId);
  });

  els.perfModeChk.addEventListener('change', (e)=>{
    state.perfMode = !!e.target.checked;
    scheduleRender();
  });

  initQuickDamageButtons();
  initBossPicker();
}
init();
</script>
</body>
</html>
